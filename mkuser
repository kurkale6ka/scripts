#! /usr/bin/env bash

shopt -s extglob

if [[ $1 == -@(h|-h)* ]]
then
   info='Usage: mkuser [/tmp/keys]'
   if (($#))
   then echo "$info"    ; exit 0
   else echo "$info" >&2; exit 1
   fi
fi

b="$(tput bold)"
y="$(printf %s "$b"; tput setaf 3)"
r="$(tput sgr0)"

# Usage: _mkauth sshkey
_mkauth () {

   # Parse ssh key
   local key="$(awk '{print $2}' <<< "$1")"

   local email="$(egrep -o '\S+$' <<< "$1")"

   local login="${email%@*}"

   read -p "Change login name $y${login}$r or Enter to accept: "

   [[ $REPLY ]] && login="$REPLY"

   # Create user
   if ! grep "$login" /etc/passwd
   then
      IFS= read -p 'Name: (First Last) ' full_name
      useradd -m -s/bin/bash -c"$full_name" "$login"
   fi

   # Install key
   mkdir -p "$HOME"/"$login"/.ssh

   if ! grep "$key" "$HOME"/"$login"/.ssh/authorized_keys
   then
      echo "$sshkey" >> "$HOME"/"$login"/.ssh/authorized_keys
   fi

   # Change permissions + ownership
   chmod 700 "$HOME"/"$login"/.ssh
   chmod 600 "$HOME"/"$login"/.ssh/authorized_keys

   chown -R "$login":"$login" "$HOME"/"$login"/.ssh
}

if (($#))
then
   if [[ $1 == -@(p|-p)* ]]
   then
      chmod 700 "$HOME"/.ssh
      chmod 600 "$HOME"/.ssh/id_rsa
      exit 0
   fi
   if [[ ! -r /tmp/keys ]]
   then
      echo 'Put the public keys in /tmp/keys please!' 1>&2
      exit 2
   else
      while read -r sshkey
      do
         [[ $sshkey = \#* ]] && continue
         _mkauth "$sshkey"
      done < /tmp/keys
   fi
else
   IFS= read -p 'Public key: ' sshkey
   _mkauth "$sshkey"
fi
