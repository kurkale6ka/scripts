#! /usr/bin/env bash

# User(s) creation + installation of public key(s)
# or
# User removal
#
# Run on the target machine
#
# Usage:
#    mkuser
#    mkuser /file/with/keys
#           ssh-rsa AAAxxx user@domain
#           ...
#    or
#    mkuser -d login

shopt -s extglob

## Colors
_bld="$(tput bold)"
_ylw="$(printf %s "$_bld"; tput setaf 3)"
_grn="$(printf %s "$_bld"; tput setaf 2)"
_red="$(printf %s "$_bld"; tput setaf 1)"
_res="$(tput sgr0)"

## Help
_help() {
read -r -d $'\0' info << 'HELP'
Usage:
   mkuser
   mkuser /file/with/keys
          ssh-rsa AAAxxx user@domain
          ...
   or
   mkuser -d login
HELP

if (($1 == 0))
then echo "$info"
else echo "$info" >&2
fi

exit "$1"
}

# Sanity checks
if (($# > 2))
then
   echo "${_red}Wrong number of arguments$_res!" >&2
   _help 1
fi

if [[ $1 == -@(h|-h)* ]]
then
   _help 0
fi

# Usage: _mkauth sshkey
_mkauth () {

   ## Key check: type key email
   if (($(awk '{print NF}' <<< $1) != 3))
   then
      echo "${_red}Wrong ssh key format$_res! Please use: type key email." 1>&2
      exit 2
   fi

   ## Parse the ssh key
   local key="$(awk '{print $2}' <<< "$1")"
   local email="$(awk '{print $3}' <<< "$1")"
   local login="${email%@*}"

   # Set the user's home directory
   if [[ $login == root ]]
   then local home=/root
   else local home=/home/"$login"
   fi

   read -p "The user's home directory is: $_ylw${home}$_res. Change the value or Enter to accept: "

   [[ $REPLY ]] && home="$REPLY"

   ## Create user
   if ! getent passwd "$login"
   then
      IFS= read -p 'Name: (First Last) ' full_name
      useradd -m -d"$home" -s/bin/bash -c"$full_name" "$login"
   elif [[ ! -d $home ]]
   then
      if mkdir -p -- "$home"
      then
         chown "$login":"$login" "$home"
      fi
   fi

   ## Install key
   if mkdir -p -- "$home"/.ssh
   then
      if ! grep -q "$key" "$home"/.ssh/authorized_keys 2>/dev/null
      then
         echo "Installing $_grn$login$_res's ssh key under $home/.ssh/authorized_keys..."
         echo "$sshkey" >> "$home"/.ssh/authorized_keys
      fi

      # Change permissions + ownership
      chmod 700 "$home"/.ssh
      chmod 600 "$home"/.ssh/authorized_keys

      chown -R "$login":"$login" "$home"/.ssh
   fi
}

## Main

# Add a single user
if (($# == 0))
then
   IFS= read -p 'Public key: ' sshkey
   _mkauth "$sshkey"
# Add several users
elif (($# == 1))
then
   # Without -u3, _mkauth's read would also read from the file vs STDIN
   while IFS= read -r -u3 sshkey
   do
      [[ $sshkey = \#* ]] && continue
      _mkauth "$sshkey"
   done 3< "$1"
# Delete a user
elif (($# == 2))
then
   if ! userdel -r "$2"
   then
      _home="$(getent passwd "$2" | cut -d: -f6)"
      if [[ -d $_home ]]
      then
         echo "Deleting ${_home}..."
         rm -rI --preserve-root -- "$_home"
      else
         echo "Local user ${_red}$2$_res doesn't exist and there is no home directory associated with him."
      fi
   fi
fi

# vim: fde=getline(v\:lnum)=~'^\\s*##'?'>'.(len(matchstr(getline(v\:lnum),'###*'))-1)\:'='
